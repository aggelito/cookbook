---
import { getCollection, render } from "astro:content";
import t from "../../i18n";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const recipes = await getCollection("recipes");
  return recipes.map((recipe) => ({
    params: { id: recipe.id },
    props: { recipe },
  }));
}

const { recipe } = Astro.props;
---

<BaseLayout title={recipe.data.title || t("recipe.untitled")}>
  <div
    class="prose
    prose-lg
    prose-li:my-0
    prose-h4:mt-6
    
    mx-auto py-12 px-6 bg-base-100 card card-border border-base-300"
  >
    <div class="recipe-header-section mb-6">
      <a href="/">{t("common.backToRecipes")}</a>
    </div>

    <div class="recipe-overview-section">
      <h1>{recipe.data.title}</h1>

      {
        recipe.data.heroImage && (
          <img
            src={recipe.data.heroImage}
            alt={recipe.data.title}
            style="max-width: 400px;"
          />
        )
      }

      <div>
        <strong>{t("recipe.portions")}</strong>
        {recipe.data.basePortions || t("common.na")}
      </div>
      <div>
        <strong>{t("recipe.estimatedTime")}</strong>
        {recipe.data.estimatedTime || t("common.na")} minutes
      </div>

      {
        recipe.data.rating != null && (
          <div>
            <strong>{t("recipe.rating")}</strong>
            {recipe.data.rating} {t("recipe.stars")}
          </div>
        )
      }

      <p>{recipe.data.description || t("recipe.noDescription")}</p>
    </div>
    <div
      class="recipe-ingredients-section prose-ul:list-none prose-ul:pl-0 prose-li:pl-0"
    >
      <h2 class="!mb-0">{t("recipe.ingredients")}</h2>
      {
        recipe.data.ingredients && recipe.data.ingredients.length > 0 && (
          <>
            <ul>
              {recipe.data.ingredients.map((ingredient, index) => (
                <li>
                  <label>
                    <input
                      type="checkbox"
                      class="checkbox checkbox-primary mr-1 recipe-checkbox"
                      data-recipe-id={recipe.id}
                      data-item-id={`ingredient-${index}`}
                      data-type="ingredient"
                    />
                    <b>{ingredient.amount}</b> {ingredient.unit} {ingredient.name}
                  </label>
                </li>
              ))}
            </ul>
          </>
        )
      }

      {
        recipe.data.ingredientGroups &&
          recipe.data.ingredientGroups.length > 0 && (
            <>
              {recipe.data.ingredientGroups.map((group, groupIndex) => (
                <div>
                  <h4>{group.groupName}</h4>
                  <ul>
                    {group.ingredients.map((ingredient, ingredientIndex) => (
                      <li>
                        <label>
                          <input
                            type="checkbox"
                            class="checkbox checkbox-primary mr-1 recipe-checkbox"
                            data-recipe-id={recipe.id}
                            data-item-id={`ingredient-group-${groupIndex}-${ingredientIndex}`}
                            data-type="ingredient"
                          />
                          <b>{ingredient.amount}</b> {ingredient.unit}{" "}
                          {ingredient.name}
                        </label>
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
            </>
          )
      }
      <div class="flex gap-2">
          <button
            id="copy-shopping-list-btn"
            class="btn btn-outline"
            data-recipe-id={recipe.id}
          >
            {t("recipe.copyShoppingList")}
          </button>
          <button
            id="reset-ingredients-btn"
            class="btn btn-outline"
            data-recipe-id={recipe.id}
          >
            {t("recipe.resetIngredients")}
          </button>
        </div>
    </div>
    <div class="recipe-steps-section prose-h4:mb-0">
      {
        recipe.data.steps && recipe.data.steps.length > 0 && (
          <>
            <h2>{t("recipe.steps")}</h2>
            {recipe.data.steps.map((step, index) => (
              <div style="margin-bottom: 1rem;">
                <h4>
                  {index + 1}. {step.title}
                </h4>
                <div set:html={step.description} />
              </div>
            ))}
          </>
        )
      }

      {
        recipe.data.stepGroups && recipe.data.stepGroups.length > 0 && (
          <>
            {recipe.data.stepGroups.map((group) => (
              <div>
                <h3>{group.groupName}</h3>
                {group.steps.map((step, index) => (
                  <div style="margin-bottom: 1rem;">
                    <h4>
                      {index + 1}. {step.title}
                    </h4>
                    <div set:html={step.description} />
                  </div>
                ))}
              </div>
            ))}
          </>
        )
      }
    </div>
    <div class="dietary-info-section">
      {
        recipe.data.dietaryInfo && (
          <>
            <h2>{t("recipe.dietaryInfo")}</h2>
            <ul>
              <li>
                {t("recipe.vegetarian")}{" "}
                {recipe.data.dietaryInfo.vegetarian
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.vegan")}{" "}
                {recipe.data.dietaryInfo.vegan
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.glutenFree")}{" "}
                {recipe.data.dietaryInfo.glutenFree
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.dairyFree")}{" "}
                {recipe.data.dietaryInfo.dairyFree
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.nutFree")}{" "}
                {recipe.data.dietaryInfo.nutFree
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.lowCarb")}{" "}
                {recipe.data.dietaryInfo.lowCarb
                  ? t("common.yes")
                  : t("common.no")}
              </li>
            </ul>
          </>
        )
      }
    </div>
    
    <div class="recipe-footer-section mt-6">
      <a href="/">{t("common.backToRecipes")}</a>
    </div>
  </div>
</BaseLayout>

<script>
  import { recipeStore, toggleIngredient, isIngredientChecked, clearIngredients } from '../../recipeStore';

  function initializeCheckboxes() {
    const checkboxes = document.querySelectorAll('.recipe-checkbox');
    
    checkboxes.forEach((checkbox) => {
      const input = checkbox as HTMLInputElement;
      const recipeId = input.dataset.recipeId!;
      const itemId = input.dataset.itemId!;
      const type = input.dataset.type as 'ingredient' | 'step';
      
      // Remove any existing listeners to prevent duplicates
      const newInput = input.cloneNode(true) as HTMLInputElement;
      input.parentNode?.replaceChild(newInput, input);
      
      // Set initial state from store
      if (type === 'ingredient') {
        newInput.checked = isIngredientChecked(recipeId, itemId);
      }
      
      // Add change listener
      newInput.addEventListener('change', () => {
        if (type === 'ingredient') {
          toggleIngredient(recipeId, itemId);
        }
      });
    });
  }

  function initializeResetButton() {
    const resetBtn = document.getElementById('reset-ingredients-btn');
    if (resetBtn) {
      const recipeId = resetBtn.dataset.recipeId!;
      
      // Clone button to remove any existing listeners
      const newResetBtn = resetBtn.cloneNode(true) as HTMLButtonElement;
      resetBtn.parentNode?.replaceChild(newResetBtn, resetBtn);
      
      newResetBtn.addEventListener('click', () => {
        // Show confirmation dialog
        if (confirm('Är du säker på att du vill återställa alla ingredienser?')) {
          // Clear from store
          clearIngredients(recipeId);
          
          // Uncheck all checkboxes in the UI
          const checkboxes = document.querySelectorAll('.recipe-checkbox[data-type="ingredient"]');
          checkboxes.forEach((checkbox) => {
            (checkbox as HTMLInputElement).checked = false;
          });
        }
      });
    }
  }

  function initializeCopyButton() {
    const copyBtn = document.getElementById('copy-shopping-list-btn');
    if (copyBtn) {
      const recipeId = copyBtn.dataset.recipeId!;
      
      // Clone button to remove any existing listeners
      const newCopyBtn = copyBtn.cloneNode(true) as HTMLButtonElement;
      copyBtn.parentNode?.replaceChild(newCopyBtn, copyBtn);
      
      newCopyBtn.addEventListener('click', async () => {
        // Collect unchecked ingredients
        const uncheckedIngredients: string[] = [];
        const checkboxes = document.querySelectorAll('.recipe-checkbox[data-type="ingredient"]');
        
        checkboxes.forEach((checkbox) => {
          const input = checkbox as HTMLInputElement;
          if (!input.checked) {
            // Get the label text and parse it
            const label = input.parentElement;
            if (label) {
              const text = label.textContent?.trim() || '';
              // Extract ingredient name, amount, and unit
              // Format: "amount unit name"
              const parts = text.split(' ').filter(p => p.length > 0);
              if (parts.length >= 3) {
                const amount = parts[0];
                const unit = parts[1];
                const name = parts.slice(2).join(' ');
                uncheckedIngredients.push(`${name} - ${amount} ${unit}`);
              }
            }
          }
        });
        
        if (uncheckedIngredients.length > 0) {
          const shoppingList = uncheckedIngredients.join('\n');
          
          try {
            await navigator.clipboard.writeText(shoppingList);
            
            // Show feedback
            const originalText = newCopyBtn.textContent;
            newCopyBtn.textContent = 'Kopierad!';
            setTimeout(() => {
              newCopyBtn.textContent = originalText;
            }, 2000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        }
      });
    }
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initializeCheckboxes();
      initializeResetButton();
      initializeCopyButton();
    });
  } else {
    initializeCheckboxes();
    initializeResetButton();
    initializeCopyButton();
  }
  
  // Re-initialize on view transitions (if using Astro view transitions)
  document.addEventListener('astro:page-load', () => {
    initializeCheckboxes();
    initializeResetButton();
    initializeCopyButton();
  });
</script>
