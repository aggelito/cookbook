---
import { getCollection, render } from "astro:content";
import t from "../../i18n";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const recipes = await getCollection("recipes");
  return recipes.map((recipe) => ({
    params: { id: recipe.id },
    props: { recipe },
  }));
}

const { recipe } = Astro.props;
---

<BaseLayout title={recipe.data.title || t("recipe.untitled")}>
  <div
    class="prose
    prose-lg
    prose-li:my-0
    prose-h4:mt-6
    
    mx-auto py-12 px-6 bg-base-100 card card-border border-base-300"
  >
    <div class="recipe-header-section mb-6">
      <a href="/">{t("common.backToRecipes")}</a>
    </div>

    <div class="recipe-overview-section">
      <h1>{recipe.data.title}</h1>

      {
        recipe.data.heroImage && (
          <img
            src={recipe.data.heroImage}
            alt={recipe.data.title}
            style="max-width: 400px;"
          />
        )
      }

      <div class="flex items-center gap-2">
        <strong>{t("recipe.portions")}</strong>
        <div class="flex items-center gap-1">
          <button
            id="decrease-portions-btn"
            class="btn btn-sm btn-circle btn-outline"
            data-recipe-id={recipe.id}
            data-base-portions={recipe.data.basePortions}
          >
            âˆ’
          </button>
          <input
            type="number"
            id="portions-input"
            class="input input-sm input-bordered w-16 text-center"
            min="1"
            data-recipe-id={recipe.id}
            data-base-portions={recipe.data.basePortions}
            value={recipe.data.basePortions}
          />
          <button
            id="increase-portions-btn"
            class="btn btn-sm btn-circle btn-outline"
            data-recipe-id={recipe.id}
            data-base-portions={recipe.data.basePortions}
          >
            +
          </button>
        </div>
      </div>
      <div>
        <strong>{t("recipe.estimatedTime")}</strong>
        {recipe.data.estimatedTime || t("common.na")} minutes
      </div>

      {
        recipe.data.rating != null && (
          <div>
            <strong>{t("recipe.rating")}</strong>
            {recipe.data.rating} {t("recipe.stars")}
          </div>
        )
      }

      <p>{recipe.data.description || t("recipe.noDescription")}</p>
    </div>
    <div
      class="recipe-ingredients-section prose-ul:list-none prose-ul:pl-0 prose-li:pl-0"
    >
      <h2>{t("recipe.ingredients")}</h2>
      {
        recipe.data.ingredients && recipe.data.ingredients.length > 0 && (
          <>
            <ul>
              {recipe.data.ingredients.map((ingredient, index) => (
                <li>
                  <label class="cursor-pointer">
                    <input
                      type="checkbox"
                      class="checkbox checkbox-primary mr-1 recipe-checkbox"
                      data-recipe-id={recipe.id}
                      data-item-id={`ingredient-${index}`}
                      data-type="ingredient"
                    />
                    <b 
                      class="ingredient-amount"
                      data-original-amount={ingredient.amount}
                    >{ingredient.amount}</b> {ingredient.unit}{" "}
                    {ingredient.name}
                  </label>
                </li>
              ))}
            </ul>
          </>
        )
      }

      {
        recipe.data.ingredientGroups &&
          recipe.data.ingredientGroups.length > 0 && (
            <>
              {recipe.data.ingredientGroups.map((group, groupIndex) => (
                <div>
                  <h4>{group.groupName}</h4>
                  <ul>
                    {group.ingredients.map((ingredient, ingredientIndex) => (
                      <li>
                        <label class="cursor-pointer">
                          <input
                            type="checkbox"
                            class="checkbox checkbox-primary mr-1 recipe-checkbox"
                            data-recipe-id={recipe.id}
                            data-item-id={`ingredient-group-${groupIndex}-${ingredientIndex}`}
                            data-type="ingredient"
                          />
                          <b 
                            class="ingredient-amount"
                            data-original-amount={ingredient.amount}
                          >{ingredient.amount}</b> {ingredient.unit}{" "}
                          {ingredient.name}
                        </label>
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
            </>
          )
      }
      <div class="flex gap-2">
        <button
          id="reset-ingredients-btn"
          class="btn btn-outline"
          data-recipe-id={recipe.id}
          data-confirm-message={t("recipe.confirmReset")}
        >
          {t("recipe.resetIngredients")}
        </button>
        <button
          id="copy-shopping-list-btn"
          class="btn btn-outline"
          data-recipe-id={recipe.id}
        >
          {t("recipe.copyShoppingList")}
        </button>
      </div>
    </div>
    <div class="recipe-steps-section prose-h4:mb-0">
      {
        recipe.data.steps && recipe.data.steps.length > 0 && (
          <>
            <h2>{t("recipe.steps")}</h2>
            {recipe.data.steps.map((step, index) => (
              <div
                class="recipe-step cursor-pointer transition-all duration-300 ease-in-out"
                data-recipe-id={recipe.id}
                data-step-id={`step-${index}`}
                data-type="step"
                style="margin-bottom: 1rem;"
              >
                <h4>
                  {index + 1}. {step.title}
                </h4>
                <div set:html={step.description} />
              </div>
            ))}
          </>
        )
      }

      {
        recipe.data.stepGroups && recipe.data.stepGroups.length > 0 && (
          <>
            {recipe.data.stepGroups.map((group, groupIndex) => (
              <div>
                <h3>{group.groupName}</h3>
                {group.steps.map((step, stepIndex) => (
                  <div
                    class="recipe-step cursor-pointer transition-all duration-300 ease-in-out"
                    data-recipe-id={recipe.id}
                    data-step-id={`step-group-${groupIndex}-${stepIndex}`}
                    data-type="step"
                    style="margin-bottom: 1rem;"
                  >
                    <h4>
                      {stepIndex + 1}. {step.title}
                    </h4>
                    <div set:html={step.description} />
                  </div>
                ))}
              </div>
            ))}
          </>
        )
      }
      <button
        id="reset-steps-btn"
        class="btn btn-outline"
        data-recipe-id={recipe.id}
        data-confirm-message={t("recipe.confirmResetSteps")}
      >
        {t("recipe.resetSteps")}
      </button>
    </div>
    <div class="dietary-info-section">
      {
        recipe.data.dietaryInfo && (
          <>
            <h2>{t("recipe.dietaryInfo")}</h2>
            <ul>
              <li>
                {t("recipe.vegetarian")}{" "}
                {recipe.data.dietaryInfo.vegetarian
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.vegan")}{" "}
                {recipe.data.dietaryInfo.vegan
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.glutenFree")}{" "}
                {recipe.data.dietaryInfo.glutenFree
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.dairyFree")}{" "}
                {recipe.data.dietaryInfo.dairyFree
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.nutFree")}{" "}
                {recipe.data.dietaryInfo.nutFree
                  ? t("common.yes")
                  : t("common.no")}
              </li>
              <li>
                {t("recipe.lowCarb")}{" "}
                {recipe.data.dietaryInfo.lowCarb
                  ? t("common.yes")
                  : t("common.no")}
              </li>
            </ul>
          </>
        )
      }
    </div>

    <div class="recipe-footer-section mt-6">
      <a href="/">{t("common.backToRecipes")}</a>
    </div>
  </div>
</BaseLayout>

<script>
  import {
    recipeStore,
    toggleIngredient,
    isIngredientChecked,
    clearIngredients,
    toggleStep,
    isStepChecked,
    clearSteps,
    hasCheckedIngredients,
    hasCheckedSteps,
    setPortions,
    getPortions,
    scaleAmount,
  } from "../../recipeStore";

  function updateResetButtonState(recipeId: string) {
    const resetBtn = document.getElementById("reset-ingredients-btn") as HTMLButtonElement;
    if (resetBtn) {
      resetBtn.disabled = !hasCheckedIngredients(recipeId);
    }
  }

  function updateResetStepsButtonState(recipeId: string) {
    const resetStepsBtn = document.getElementById("reset-steps-btn") as HTMLButtonElement;
    if (resetStepsBtn) {
      resetStepsBtn.disabled = !hasCheckedSteps(recipeId);
    }
  }

  function updateIngredientAmounts(recipeId: string, basePortions: number, currentPortions: number) {
    const amounts = document.querySelectorAll(".ingredient-amount");
    amounts.forEach((amountEl) => {
      const originalAmount = amountEl.getAttribute("data-original-amount");
      if (originalAmount) {
        const scaledAmount = scaleAmount(originalAmount, basePortions, currentPortions);
        amountEl.textContent = scaledAmount;
      }
    });
  }

  function initializePortions() {
    const portionsInput = document.getElementById("portions-input") as HTMLInputElement;
    const decreaseBtn = document.getElementById("decrease-portions-btn");
    const increaseBtn = document.getElementById("increase-portions-btn");
    
    if (!portionsInput || !decreaseBtn || !increaseBtn) return;
    
    const recipeId = portionsInput.dataset.recipeId!;
    const basePortions = parseInt(portionsInput.dataset.basePortions || "4");
    
    // Load saved portions from store
    const savedPortions = getPortions(recipeId, basePortions);
    portionsInput.value = savedPortions.toString();
    
    // Update amounts if portions were previously adjusted
    if (savedPortions !== basePortions) {
      updateIngredientAmounts(recipeId, basePortions, savedPortions);
    }
    
    // Clone elements to remove existing listeners
    const newInput = portionsInput.cloneNode(true) as HTMLInputElement;
    const newDecreaseBtn = decreaseBtn.cloneNode(true) as HTMLButtonElement;
    const newIncreaseBtn = increaseBtn.cloneNode(true) as HTMLButtonElement;
    
    portionsInput.parentNode?.replaceChild(newInput, portionsInput);
    decreaseBtn.parentNode?.replaceChild(newDecreaseBtn, decreaseBtn);
    increaseBtn.parentNode?.replaceChild(newIncreaseBtn, increaseBtn);
    
    // Function to update portions
    const updatePortions = (newPortions: number) => {
      if (newPortions < 1) return;
      
      newInput.value = newPortions.toString();
      setPortions(recipeId, newPortions);
      updateIngredientAmounts(recipeId, basePortions, newPortions);
    };
    
    // Decrease button
    newDecreaseBtn.addEventListener("click", () => {
      const current = parseInt(newInput.value);
      updatePortions(current - 1);
    });
    
    // Increase button
    newIncreaseBtn.addEventListener("click", () => {
      const current = parseInt(newInput.value);
      updatePortions(current + 1);
    });
    
    // Input change
    newInput.addEventListener("change", () => {
      const newValue = parseInt(newInput.value);
      if (!isNaN(newValue) && newValue >= 1) {
        updatePortions(newValue);
      } else {
        newInput.value = getPortions(recipeId, basePortions).toString();
      }
    });
  }

  function initializeCheckboxes() {
    const checkboxes = document.querySelectorAll(".recipe-checkbox");

    checkboxes.forEach((checkbox) => {
      const input = checkbox as HTMLInputElement;
      const recipeId = input.dataset.recipeId!;
      const itemId = input.dataset.itemId!;
      const type = input.dataset.type as "ingredient" | "step";

      // Remove any existing listeners to prevent duplicates
      const newInput = input.cloneNode(true) as HTMLInputElement;
      input.parentNode?.replaceChild(newInput, input);

      // Set initial state from store
      if (type === "ingredient") {
        newInput.checked = isIngredientChecked(recipeId, itemId);
      }

      // Add change listener
      newInput.addEventListener("change", () => {
        if (type === "ingredient") {
          toggleIngredient(recipeId, itemId);
          // Update reset button state
          updateResetButtonState(recipeId);
        }
      });
    });
  }

  function initializeResetButton() {
    const resetBtn = document.getElementById("reset-ingredients-btn");
    if (resetBtn) {
      const recipeId = resetBtn.dataset.recipeId!;
      const confirmMessage = resetBtn.dataset.confirmMessage!;

      // Clone button to remove any existing listeners
      const newResetBtn = resetBtn.cloneNode(true) as HTMLButtonElement;
      resetBtn.parentNode?.replaceChild(newResetBtn, resetBtn);
      
      // Set initial disabled state
      newResetBtn.disabled = !hasCheckedIngredients(recipeId);

      newResetBtn.addEventListener("click", () => {
        // Show confirmation dialog with translated message
        if (confirm(confirmMessage)) {
          // Clear from store
          clearIngredients(recipeId);

          // Uncheck all checkboxes in the UI
          const checkboxes = document.querySelectorAll(
            '.recipe-checkbox[data-type="ingredient"]'
          );
          checkboxes.forEach((checkbox) => {
            (checkbox as HTMLInputElement).checked = false;
          });
          
          // Update button state after clearing
          updateResetButtonState(recipeId);
        }
      });
    }
  }

  function initializeSteps() {
    const steps = document.querySelectorAll(".recipe-step");

    steps.forEach((step) => {
      const stepDiv = step as HTMLDivElement;
      const recipeId = stepDiv.dataset.recipeId!;
      const stepId = stepDiv.dataset.stepId!;

      // Clone to remove existing listeners
      const newStepDiv = stepDiv.cloneNode(true) as HTMLDivElement;
      stepDiv.parentNode?.replaceChild(newStepDiv, stepDiv);

      // Set initial state from store
      if (isStepChecked(recipeId, stepId)) {
        newStepDiv.classList.add("line-through");
      }

      // Add click listener
      newStepDiv.addEventListener("click", () => {
        toggleStep(recipeId, stepId);

        // Toggle line-through class
        if (newStepDiv.classList.contains("line-through")) {
          newStepDiv.classList.remove("line-through");
        } else {
          newStepDiv.classList.add("line-through");
        }
        
        // Update reset steps button state
        updateResetStepsButtonState(recipeId);
      });
    });
  }

  function initializeCopyButton() {
    const copyBtn = document.getElementById("copy-shopping-list-btn");
    if (copyBtn) {
      const recipeId = copyBtn.dataset.recipeId!;

      // Clone button to remove any existing listeners
      const newCopyBtn = copyBtn.cloneNode(true) as HTMLButtonElement;
      copyBtn.parentNode?.replaceChild(newCopyBtn, copyBtn);

      newCopyBtn.addEventListener("click", async () => {
        // Collect unchecked ingredients
        const uncheckedIngredients: string[] = [];
        const checkboxes = document.querySelectorAll(
          '.recipe-checkbox[data-type="ingredient"]'
        );

        checkboxes.forEach((checkbox) => {
          const input = checkbox as HTMLInputElement;
          if (!input.checked) {
            // Get the label text and parse it
            const label = input.parentElement;
            if (label) {
              const text = label.textContent?.trim() || "";
              // Extract ingredient name, amount, and unit
              // Format: "amount unit name"
              const parts = text.split(" ").filter((p) => p.length > 0);
              if (parts.length >= 3) {
                const amount = parts[0];
                const unit = parts[1];
                const name = parts.slice(2).join(" ");
                uncheckedIngredients.push(`${name} - ${amount} ${unit}`);
              }
            }
          }
        });

        if (uncheckedIngredients.length > 0) {
          const shoppingList = uncheckedIngredients.join("\n");

          try {
            await navigator.clipboard.writeText(shoppingList);

            // Show feedback
            const originalText = newCopyBtn.textContent;
            newCopyBtn.textContent = "Kopierad!";
            setTimeout(() => {
              newCopyBtn.textContent = originalText;
            }, 2000);
          } catch (err) {
            console.error("Failed to copy:", err);
          }
        }
      });
    }
  }

  function initializeResetStepsButton() {
    const resetStepsBtn = document.getElementById("reset-steps-btn");
    if (resetStepsBtn) {
      const recipeId = resetStepsBtn.dataset.recipeId!;
      const confirmMessage = resetStepsBtn.dataset.confirmMessage!;

      // Clone button to remove any existing listeners
      const newResetStepsBtn = resetStepsBtn.cloneNode(
        true
      ) as HTMLButtonElement;
      resetStepsBtn.parentNode?.replaceChild(newResetStepsBtn, resetStepsBtn);
      
      // Set initial disabled state
      newResetStepsBtn.disabled = !hasCheckedSteps(recipeId);

      newResetStepsBtn.addEventListener("click", () => {
        // Show confirmation dialog with translated message
        if (confirm(confirmMessage)) {
          // Clear from store
          clearSteps(recipeId);

          // Remove line-through from all steps in the UI
          const steps = document.querySelectorAll(".recipe-step");
          steps.forEach((step) => {
            step.classList.remove("line-through");
          });
          
          // Update button state after clearing
          updateResetStepsButtonState(recipeId);
        }
      });
    }
  }

  // Initialize on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initializePortions();
      initializeCheckboxes();
      initializeSteps();
      initializeResetButton();
      initializeResetStepsButton();
      initializeCopyButton();
    });
  } else {
    initializePortions();
    initializeCheckboxes();
    initializeSteps();
    initializeResetButton();
    initializeResetStepsButton();
    initializeCopyButton();
  }
  
  // Re-initialize on view transitions (if using Astro view transitions)
  document.addEventListener("astro:page-load", () => {
    initializePortions();
    initializeCheckboxes();
    initializeSteps();
    initializeResetButton();
    initializeResetStepsButton();
    initializeCopyButton();
  });
</script>
